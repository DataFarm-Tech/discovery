name: Discovery Deployment

on:
  push:
    branches:
      - feat/create-list-paddock

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_LOGIN_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_LOGIN_USERNAME }}" --password-stdin

      # Build Docker image
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_LOGIN_USERNAME }}/discovery:latest .

      # Push Docker image
      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_LOGIN_USERNAME }}/discovery:latest

      # SSH into Linode and deploy
      - name: Deploy on Linode
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # Stop & remove old containers
            docker stop app || true
            docker rm app || true
            docker stop caddy || true
            docker rm caddy || true

            # Pull latest Next.js image
            docker pull ${{ secrets.DOCKER_LOGIN_USERNAME }}/discovery:latest

            # Run Next.js container
            docker run -d \
              --name app \
              -e NODE_ENV=production \
              -p 3000:3000 \
              ${{ secrets.DOCKER_LOGIN_USERNAME }}/discovery:latest

            # Run Caddy container
            docker run -d \
              --name caddy \
              -p 80:80 -p 443:443 \
              -v caddy_data:/data \
              -v caddy_config:/config \
              -v /home/${{ secrets.USER }}/Caddyfile:/etc/caddy/Caddyfile \
              --link app:app \
              caddy:latest

            echo "Deployment completed successfully!"
